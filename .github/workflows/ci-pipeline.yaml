name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: madushanka-devops

jobs:
  # JOB 1: Calculate Version
  get-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.versioning.outputs.version }}
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Calculate Semantic Version
        id: versioning
        uses: paulhatch/semantic-version@v5.4.0
        with:
          bump_each_commit: true
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: "${major}.${minor}.${patch}"
          user_format_type: "csv"

  # JOB 2: Code Quality Gate (Tests & Linting)
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # If one service fails, let others finish testing
      matrix:
        include:
          - folder: product-service
            language: python
          - folder: cart-service
            language: go
          - folder: frontend
            language: node

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- SETUP ENVIRONMENTS ---
      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Setup Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Setup Node
        if: matrix.language == 'node'
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # --- INSTALL DEPENDENCIES ---
      - name: Install Python Deps
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        run: |
          pip install -r requirements.txt
          pip install pytest flake8

      - name: Install Node Deps
        if: matrix.language == 'node'
        working-directory: ./${{ matrix.folder }}
        run: npm ci

      # --- RUN LINTING ---
      - name: Lint Python (Flake8)
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        # Stop the build if there are Python syntax errors or undefined names
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Lint Go (Go Vet)
        if: matrix.language == 'go'
        working-directory: ./${{ matrix.folder }}
        run: go vet ./...

      # (Optional) Lint Node - skipping for now unless you have eslint configured
      # - name: Lint Node
      #   if: matrix.language == 'node'
      #   run: npm run lint

      # --- RUN UNIT TESTS ---
      - name: Test Python
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        run: pytest

      - name: Test Go
        if: matrix.language == 'go'
        working-directory: ./${{ matrix.folder }}
        run: go test -v ./...

      - name: Test Node
        if: matrix.language == 'node'
        working-directory: ./${{ matrix.folder }}
        # CI=true forces the test runner to exit after running, instead of waiting for input
        run: npm test -- --watchAll=false
        env:
          CI: true

  # JOB 3: Build & Push (Runs ONLY if tests pass)
  build-and-push:
    needs: [get-version, code-quality] # <--- WAITS FOR TESTS TO PASS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - folder: product-service
            image_name: microservices-product
          - folder: cart-service
            image_name: microservices-cart
          - folder: frontend
            image_name: microservices-frontend
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Images
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.folder }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:latest

  # JOB 4: Update Manifests
  update-manifests:
    needs: [get-version, build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repo
        uses: actions/checkout@v3
        with:
          repository: madushanka-devops/microservices-infra
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infra-repo

      - name: Install yq
        run: sudo snap install yq

      - name: Update Kubernetes Manifests
        run: |
          NEW_TAG=${{ needs.get-version.outputs.new_version }}
          REGISTRY_ROOT=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}
          
          echo "Updating manifests to version $NEW_TAG"

          for env in dev staging production; do
             FILE="infra-repo/$env/deploy-all.yaml"
             if [ -f "$FILE" ]; then
                echo "Updating $FILE..."
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"product-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-product:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"cart-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-cart:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"frontend\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-frontend:$NEW_TAG\"" $FILE
             fi
          done

      - name: Commit and Push Changes
        working-directory: infra-repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [[ -n $(git status -s) ]]; then
            echo "Changes detected. Committing..."
            git add .
            git commit -m "Update image versions to ${{ needs.get-version.outputs.new_version }}"
            git push
          else
            echo "No changes detected. Skipping commit."
          fi
