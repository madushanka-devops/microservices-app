name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: madushanka-devops

jobs:
  # PHASE 1: VERSIONING
  get-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.versioning.outputs.version }}
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Calculate Semantic Version
        id: versioning
        uses: paulhatch/semantic-version@v5.4.0
        with:
          bump_each_commit: true
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: "${major}.${minor}.${patch}"
          user_format_type: "csv"

  # PHASE 2A: CODE QUALITY GATE (Unit Tests & Linting)
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - folder: product-service
            language: python
          - folder: cart-service
            language: go
          - folder: frontend
            language: node
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # --- SETUP ---
      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Setup Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Setup Node
        if: matrix.language == 'node'
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      # --- INSTALL & TEST (Same as before) ---
      - name: Install Python Deps
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        run: |
          pip install -r requirements.txt || true
          pip install pytest flake8
      - name: Install Node Deps
        if: matrix.language == 'node'
        working-directory: ./${{ matrix.folder }}
        run: npm install
      - name: Lint Python
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      - name: Lint Go
        if: matrix.language == 'go'
        working-directory: ./${{ matrix.folder }}
        run: go vet ./...
      - name: Test Python
        if: matrix.language == 'python'
        working-directory: ./${{ matrix.folder }}
        run: pytest tests/
      - name: Test Go
        if: matrix.language == 'go'
        working-directory: ./${{ matrix.folder }}
        run: go test -v ./...
      - name: Test Node
        if: matrix.language == 'node'
        working-directory: ./${{ matrix.folder }}
        run: npm test -- --watchAll=false
        env:
          CI: true

  # PHASE 2B: SAST SECURITY SCAN (*** NEW JOB ***) using Semgrep
  sast-security:
    runs-on: ubuntu-latest
    name: Semgrep SAST Scan
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/default # Uses standard security ruleset
          # Optional: Audit mode only (won't fail build). 
          # Remove 'auditOn' to make it fail the build on errors.
          # auditOn: push 

  # PHASE 3: BUILD, SCAN (SCA), SBOM & PUSH
  build-scan-push:
    # NOW WAITS FOR BOTH QUALITY AND SECURITY GATES
    needs: [get-version, code-quality, sast-security] 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write 
    strategy:
      fail-fast: false
      matrix:
        include:
          - folder: product-service
            image_name: microservices-product
          - folder: cart-service
            image_name: microservices-cart
          - folder: frontend
            image_name: microservices-frontend
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.folder }}
          load: true 
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}

      # TRIVY SCAN (Updated to use Ignore File)
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          trivyignores: .trivyignore


      # GENERATE SBOM
      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}
          format: 'cyclonedx'
          output: 'sbom-${{ matrix.image_name }}.json'

      # UPLOAD SBOM
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.image_name }}
          path: sbom-${{ matrix.image_name }}.json

      # PUSH
      - name: Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.folder }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:latest

  # PHASE 4: UPDATE INFRASTRUCTURE
  update-manifests:
    needs: [get-version, build-scan-push]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repo
        uses: actions/checkout@v3
        with:
          repository: madushanka-devops/microservices-infra
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infra-repo
      - name: Install yq
        run: sudo snap install yq
      - name: Update Kubernetes Manifests
        run: |
          NEW_TAG=${{ needs.get-version.outputs.new_version }}
          REGISTRY_ROOT=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}
          echo "Updating manifests to version $NEW_TAG"
          for env in dev staging production; do
             FILE="infra-repo/$env/deploy-all.yaml"
             if [ -f "$FILE" ]; then
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"product-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-product:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"cart-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-cart:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"frontend\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-frontend:$NEW_TAG\"" $FILE
             fi
          done
      - name: Commit and Push Changes
        working-directory: infra-repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update image versions to ${{ needs.get-version.outputs.new_version }}"
            git push
          fi