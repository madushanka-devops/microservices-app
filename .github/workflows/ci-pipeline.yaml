name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: madushanka-devops

jobs:
  # JOB 1: Calculate Version
  get-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.versioning.outputs.version }}
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Calculate Semantic Version
        id: versioning
        uses: paulhatch/semantic-version@v5.4.0
        with:
          # Critical: Ensures version changes on every push
          bump_each_commit: true
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: "${major}.${minor}.${patch}"
          user_format_type: "csv"

  # JOB 2: Build & Push (Parallel)
  build-and-push:
    needs: get-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - folder: product-service
            image_name: microservices-product
          - folder: cart-service
            image_name: microservices-cart
          - folder: frontend
            image_name: microservices-frontend
    steps:
      - name: Checkout App Repo
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Images
        uses: docker/build-push-action@v4
        with:
          context: ./${{ matrix.folder }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:${{ needs.get-version.outputs.new_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.image_name }}:latest

  # JOB 3: Update Manifests
  update-manifests:
    needs: [get-version, build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Infra Repo
        uses: actions/checkout@v3
        with:
          repository: madushanka-devops/microservices-infra
          token: ${{ secrets.INFRA_REPO_PAT }}
          path: infra-repo

      - name: Install yq
        run: sudo snap install yq

      - name: Update Kubernetes Manifests
        run: |
          NEW_TAG=${{ needs.get-version.outputs.new_version }}
          REGISTRY_ROOT=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}
          
          echo "Updating manifests to version $NEW_TAG"

          for env in dev staging production; do
             FILE="infra-repo/$env/deploy-all.yaml"
             if [ -f "$FILE" ]; then
                echo "Updating $FILE..."
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"product-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-product:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"cart-service\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-cart:$NEW_TAG\"" $FILE
                yq -i "select(.kind == \"Deployment\" and .metadata.name == \"frontend\").spec.template.spec.containers[0].image = \"$REGISTRY_ROOT/microservices-frontend:$NEW_TAG\"" $FILE
             fi
          done

      - name: Commit and Push Changes
        working-directory: infra-repo
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [[ -n $(git status -s) ]]; then
            echo "Changes detected. Committing..."
            git add .
            git commit -m "Update image versions to ${{ needs.get-version.outputs.new_version }}"
            git push
          else
            echo "No changes detected. Skipping commit."
          fi
